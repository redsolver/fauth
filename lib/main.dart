import'dart:io';import'dart:async';import'package:flare_flutter/flare_controller.dart';import'package:path_provider/path_provider.dart';import'package:clipboard_manager/clipboard_manager.dart';import'package:flutter/material.dart';import'package:qrcode_reader/qrcode_reader.dart';import'package:material_design_icons_flutter/material_design_icons_flutter.dart';import'package:objectdb/objectdb.dart';import'package:otp/otp.dart';import'package:flutter_i18n/flutter_i18n.dart';import'package:flutter_i18n/flutter_i18n_delegate.dart';import'package:flutter_localizations/flutter_localizations.dart';import'package:flare_flutter/flare_actor.dart';import'package:dynamic_theme/dynamic_theme.dart';import'package:flutter_slidable/flutter_slidable.dart';import'package:intro_slider/intro_slider.dart';var cx,db,dbF,e,dbP,cd,sS,sC,ct,sK,r,ar,ctrl;var d=[];o(){db=ObjectDB(dbP);db.open();}var bL=Brightness.light;var bD=Brightness.dark;t(k,[p])=>FlutterI18n.translate(cx,k,p);main()async{ct=StreamController.broadcast();sK=GlobalKey();dbP=(await getApplicationDocumentsDirectory()).path+'/otp.db';dbF=File(dbP);e=dbF.existsSync();if(e)o();to();runApp(DynamicTheme(defaultBrightness:bL,data:(b)=>ThemeData(primarySwatch:Colors.indigo,brightness:b),themedWidgetBuilder:(cx,th)=>MaterialApp(initialRoute:e?'h':'i',routes:{'h':(c)=>h(),'i':(c)=>i(c)},theme:th,title:'FAuth',localizationsDelegates:[FlutterI18nDelegate(path:'assets/i18n',fallbackFile:'en'),GlobalMaterialLocalizations.delegate,GlobalWidgetsLocalizations.delegate])));}i(c){cx=c;return IntroSlider(slides:[1,2,3,4,5,6,7,8].map((i)=>Slide(title:t('ST$i'),description:t('SD$i'),pathImage:'assets/images/s$i.gif',backgroundColor:Colors.green)).toList(),nameDoneBtn:t('d'),nameNextBtn:t('n'),isShowSkipBtn:false,onDonePress:(){o();db.insert({'a':t('tA'),'s':t('tS'),'p':30,'d':6,'o':0});nO(c).pushReplacementNamed('h');});}ro(o,n)async{if(n>o)n-=1;cd=await db.find({});for(var c in cd){int i=c['o'];if(i==o){i=n;}else if(i>=n&&i<o){i++;}else if(i>o&&i<=n){i--;}await db.update({'_id':c['_id']},{'o':i});}}h()=>StatefulBuilder(builder:(c,s){sS=s;cx=c;return Scaffold(key:sK,appBar:AppBar(title:Text(t('t')),actions:[IconButton(icon:Icon(MdiIcons.themeLightDark),onPressed:()=>DynamicTheme.of(c).setBrightness(DynamicTheme.of(c).brightness==bD?bL:bD))]),body:FutureBuilder(future:db.find({}),builder:(c,s){if(!s.hasData)return Container();d=s.data.map((m)=>OC.fJ(m)).toList();d.sort((a,b)=>a.o.compareTo(b.o));return ReorderableListView(children:d.map<Widget>((c)=>cL(c)).toList(),onReorder:(a,b)=>ro(a,b).then((_)=>st()));}),floatingActionButton:FloatingActionButton(child:Icon(MdiIcons.qrcodeScan),onPressed:()=>aC().then((_)=>st())));});to(){ct.add(m);Future.delayed(du(n.second<30?3:6)).then((_)=>to());}du(i)=>Duration(milliseconds:i*10000-n.millisecond-n.second*1000);get n=>DateTime.now();get m=>n.millisecondsSinceEpoch;spl(s){r='';var i=false;for(var c in s.split('')){r+=c;if(i)r+=' ';i=!i;}return r.trim();}gen(c,t){var s='${OTP.generateTOTPCode(c.s,t,interval:c.p,length:c.d)}';while(s.length<c.d)s='0$s';return s;}sD(c,d){ctrl=TextEditingController(text:c.a);return showDialog(context:sK.currentContext,builder:(ct)=>AlertDialog(title:Text(t(d?'dDT':'eDT')),content:d?Text(t('dDC',{'n':'${c.a}'})):TextField(controller:ctrl),actions:[FlatButton(child:Text(t('c')),onPressed:()=>nO(ct).pop()),FlatButton(child:Text(t(d?'de':'s')),onPressed:()async{if(d){await ro(c.o,99999);await db.remove({'o':99998});}else{await db.update({'o':c.o},{'a':ctrl.text});}nO(cx).pop();})]));}nO(c)=>Navigator.of(c);cL(c)=>Slidable(key:ValueKey(c),delegate:SlidableDrawerDelegate(),child:ListTile(title:Text(c.a),onTap:()=>cp(gen(c,m)),leading:Container(child:FlareActor('assets/flare/progress.flr',animation:'default',controller:C()),width:40,height:40),subtitle:StreamBuilder(builder:(_,s)=>Text(spl(gen(c,s.data)),style:Theme.of(cx).textTheme.body1.copyWith(fontSize:30)),stream:ct.stream,initialData:m)),actions:['de','ed'].map((s)=>IconSlideAction(caption:t(s),color:s=='de'?Colors.red:Colors.yellow,icon:s=='de'?Icons.delete:Icons.edit,onTap:()async{await sD(c,s=='de');st();})).toList());st()=>sS((){});cp(c)=>ClipboardManager.copyToClipBoard(c).then((_){s('cp');});s(key){sK.currentState.showSnackBar(SnackBar(content:Text(t(key))));}aC()async{try{var sc=await QRCodeReader().scan();if(sc==null){s('nSc');return;}sc=Uri.decodeFull(sc);var ty=sc.split('otpauth://')[1].split('/')[0];if(ty!='totp'){s('nSu');return;}var c=OC();c.a=sc.split('/').last.split('?')[0].replaceFirst(':',' - ');ar={};sc.split('?').last.split('&').forEach((s)=>ar[s.split('=')[0]]=s.split('=')[1]);c.d=int.tryParse(ar['digits']??'6');c.p=int.tryParse(ar['period']??'30');c.s=ar['secret'];c.o=d.isEmpty?0:d.last.o+1;await db.insert(c.tJ());}catch(e){s('e');}}class C implements FlareController{var a;initialize(ab){a=ab.getAnimation('default');}advance(ab,_){a.apply(((n.millisecond+n.second*1000)%30000/1000),ab,1.0);return false;}setViewTransform(_){}}class OC{var a,s,p,d,o;OC();tJ()=>{'a':a,'s':s,'p':p,'d':d,'o':o};OC.fJ(m){a=m['a'];s=m['s'];p=m['p'];d=m['d'];o=m['o'];}}